function loadFile(t){var e=new XMLHttpRequest;if(e.open("GET",t,!1),e.send(null),200==e.status)return e.responseText;try{return e.responseText}catch(t){return null}}function apiRequest(t){var e=new XMLHttpRequest;if(e.open("GET",t,!1),e.send(null),200==e.status)return JSON.parse(e.responseText);try{return JSON.parse(e.responseText)}catch(t){return null}}function getQueryStringValue(t){return unescape(window.location.search.replace(new RegExp("^(?:.*[&\\?]"+escape(t).replace(/[\.\+\*]/g,"\\$&")+"(?:\\=([^&]*))?)?.*$","i"),"$1"))}CONFIG={api_url:"http://zeroslant.com/api/v0.2/"};var Block=function(){this.type="asset",this.animationData={}};Block.prototype.loadTemplate=function(t){this.folder=t.replace(/\/[^\/]+\/?$/,""),this.blockId=this.folder,this.getType();var e=loadFile(t);this.animationData=JSON.parse(e);var s=loadFile(this.folder+"/placeholders.json");this.animationData.placeholders=JSON.parse(s),this.setBaseFolder()},Block.prototype.getType=function(){var t=this.blockId.toLowerCase();t.indexOf("title")!==-1?this.type="title":t.indexOf("end")!==-1?this.type="end":this.type="asset"},Block.prototype.setBaseFolder=function(){for(var t=0;t<this.animationData.assets.length;t++){var e=this.animationData.assets[t];this.isImageAsset(e)&&(e.u=this.folder+"/images/")}},Block.prototype.setFont=function(t){this.animationData.chars=t.chars,this.animationData.fonts.list=t.fonts.list},Block.prototype.setColorPallete=function(t){this.animationData.assets.push(t)},Block.prototype.loadFonts=function(t){for(var e=this,s=[],o=0;o<t.length;o++){var a=JSON.parse(e.loadFile(t[o]));s=s.concat(a.chars)}this.animationData.chars=s},Block.prototype.fillTemplate=function(t){if(t.length<this.animationData.placeholders.assets.length)return{error:!0,message:"not enough assets provided"};console.log(t);for(var e=0;e<this.animationData.placeholders.assets.length;e++)this.fillData(this.animationData.placeholders.assets[e],t[e]);return{error:!1}},Block.prototype.fillData=function(t,e){var s=this;for(var o in t)if("usericon"!=o)for(var a=t[o],n=0;n<a.length;n++){var i=a[n],r=this.animationData.layers[i.idx],l=e.get(o);if("text"==i.type){if("en"!=CONFIG.language&&"tweetbody"==o){var h=new GoogleApi;l.text=h.translate(l.text,"en",CONFIG.language)}s.setText(r,l)}else"image"==i.type&&"video"==l.type?s.setVideo(r,l):"image"==i.type&&s.setImage(r,l)}},Block.prototype.setText=function(t,e){for(var s=t;!this.isTextLayer(s);)if("refId"in s)s=this.findAsset(s.refId);else{if(!("layers"in s))return console.log("Bad Text Layer"),void console.log(t);for(var o in s.layers)if(this.isTextLayer(s.layers[o])){s=s.layers[o];break}for(var o in s.layers)if("refId"in s.layers[o]){s=this.findAsset(s.layers[o].refId);break}}s.t.d.t=e.text,s.t.d.mf=Math.min(e.mf,s.t.d.s),s.t.d.f="NotoSans",s.nm,s.t.d.f="NotoSans-Bold",s.t.d.fStyle="bold",s.t.d.fWeight=700,e.fc&&(s.t.d.fc=e.fc)},Block.prototype.setImage=function(t,e){for(var s=t;!this.isImageAsset(s);)if("refId"in s)s=this.findAsset(s.refId);else{if(!("layers"in s))return console.log("Bad Image Layer"),void console.log(t);for(var o in s.layers){var a=s.layers[o];if("refId"in a){this.setImageLayer(a),s=this.findAsset(s.layers[o].refId);break}}}s.u="",s.p=e.url},Block.prototype.setVideo=function(t,e){for(var s=t;!this.isImageAsset(s);)if("refId"in s)s=this.findAsset(s.refId);else{if(!("layers"in s))return console.log("Bad Video Layer"),void console.log(t);for(var o in s.layers){var a=s.layers[o];if("refId"in a){this.setVideoLayer(a),s=this.findAsset(s.layers[o].refId);break}}}s.u=e.dir,s.p="frame1.png",s.nf=e.n_frames},Block.prototype.isImageAsset=function(t){return"id"in t&&"u"in t&&"p"in t&&"h"in t&&"w"in t},Block.prototype.isVideoLayer=function(t){return"ty"in t&&9==t.ty},Block.prototype.isTextLayer=function(t){return"t"in t&&"d"in t.t&&"f"in t.t.d},Block.prototype.setImageLayer=function(t){"ty"in t&&0!=t.ty&&(t.ty=2,t.cl="jpg")},Block.prototype.setVideoLayer=function(t){"ty"in t&&0!=t.ty&&(t.ty=9,t.cl="mp4")},Block.prototype.findAsset=function(t){for(var e=0;e<this.animationData.assets.length;e++)if(this.animationData.assets[e].id==t)return this.animationData.assets[e]},Block.prototype.loadFile=function(t){var e=new XMLHttpRequest;if(e.open("GET",t,!1),e.send(null),200==e.status)return e.responseText;try{return e.responseText}catch(t){return null}},Block.prototype.findKeyframes=function(){for(var t=0;t<this.animationData.layers.length;t++){var e=this.animationData.layers[t];for(var s in e)if(e.hasOwnProperty(s)){e[s]}}},Block.prototype.iterate=function(t){};var ColorManager=function(){this.folder="_ColorPalletes/",this.pallete={}};ColorManager.prototype.loadPallete=function(t){this.pallete=JSON.parse(loadFile(this.palleteFile(t)))},ColorManager.prototype.palleteFile=function(t){return this.folder+t+".json"};var FontManager=function(){this.folder="_fonts/",this.chars=null,this.fonts={list:[{fFamily:"Noto Sans",fName:"NotoSans",fStyle:"Regular",fWeight:400,fPath:"https://fonts.googleapis.com/css?family=Noto+Sans:400,400i",fOrigin:"g",ascent:75.97},{fFamily:"Noto Sans",fName:"NotoSans-Bold",fStyle:"Bold",fWeight:700,fPath:"https://fonts.googleapis.com/css?family=Noto+Sans:700,700i",fOrigin:"g",ascent:75.97}]}};FontManager.prototype.loadFonts=function(t){switch(t){case"default":this.load(["English","Numbers","ArialMT"]);break;default:this.load(["English","Numbers","ArialMT"])}},FontManager.prototype.load=function(t){for(var e=0;e<t.length;e++){var s=JSON.parse(loadFile(this.fontFile(t[e])));this.addFont(s)}},FontManager.prototype.addFont=function(t){this.chars=this.chars.concat(t.chars),this.fonts.list=this.fonts.list.concat(t.fonts.list)},FontManager.prototype.fontFile=function(t){return this.folder+t+".json"},FontManager.prototype.getFontFor=function(t){return this.fonts.list[0].fName};var GoogleApi=function(){this.GOOGLE_API_KEY="AIzaSyDT9Hw8wqem-pJm6wS1rz6JtSAd5SEyXk4"};GoogleApi.prototype.translate=function(t,e,s){var o="https://www.googleapis.com/language/translate/v2?key="+this.GOOGLE_API_KEY+"&q="+encodeURIComponent(t)+"&source="+e+"&target="+s,a=apiRequest(o);return!("error"in a)&&"data"in a&&"translations"in a.data&&a.data.translations.length>0?(console.log("translated:"+a.data.translations[0].translatedText),a.data.translations[0].translatedText):t};var TemplateManager=function(t){this.type="template_v2",this.folder="_templates_v2/",this.configure(t),this.previousBlock=""};TemplateManager.prototype.configure=function(t){for(var e in t)this[e]=t[e];this.loadFonts(),this.loadColors(),this.TITLE_TEMPLATES=["TitleCard_01","TitleCard_02","TitleCard_03","TitleCard_04","TitleCard_06"],this.END_TEMPLATES=["EndCard_01","EndCard_02"],this.CONTENT_TEMPLATES=["Block_01","Block_02","Block_03","Block_04","Block_05","Block_06","Block_07","Block_08","Block_09","Block_10","Block_11","Block_12","Block_13","Block_14","Block_15","Block_16","Block_17"],"template_v2"==this.type?this.CONTENT_TEMPLATES_SINGLE=["Block_01","Block_04","Block_05","Block_06","Block_07","Block_08","Block_12","Block_13","Block_14","Block_15","Block_16"]:"template_ace"==this.type&&(this.CONTENT_TEMPLATES_SINGLE=["Block_01","Block_04","Block_06","Block_07","Block_13","Block_14","Block_16","Block_17"])},TemplateManager.prototype.loadFonts=function(){this.fontManager=new FontManager},TemplateManager.prototype.loadColors=function(){this.colorManager=new ColorManager,this.colorManager.loadPallete(this.type)},TemplateManager.prototype.getTitleBlock=function(){var t=this.folder+this.TITLE_TEMPLATES.random()+"/data.json";return this.loadBlock(t)},TemplateManager.prototype.getEndBlock=function(){var t=this.folder+this.END_TEMPLATES.random()+"/data.json";return this.loadBlock(t)},TemplateManager.prototype.getContentBlock=function(t){var e=this.CONTENT_TEMPLATES;void 0!==t.maxAssets&&1==t.maxAssets&&(e=this.CONTENT_TEMPLATES_SINGLE);var s=e.slice();return s.indexOf(this.previousBlock)>-1&&s.splice(s.indexOf(this.previousBlock),1),this.previousBlock=s.random(),this.loadBlock(this.folder+this.previousBlock+"/data.json")},TemplateManager.prototype.getBlockById=function(t){return this.loadBlock(this.folder+t+"/data.json")},TemplateManager.prototype.loadBlock=function(t){console.log("loading "+t);var e=new Block;return e.loadTemplate(t),e.setFont(this.fontManager),e.setColorPallete(this.colorManager.pallete),e};var Asset=function(t){if(this._max_tags=5,this.type="image","string"==typeof t)if("phantom"==CONFIG.platform){var e=".data/"+CONFIG.storyId+"/assets/"+t+"/asset.json",s=loadFile(e);t=JSON.parse(s)}else console.log("TODO: get Asset Data from API");for(var o in t)this[o]=t[o]};Asset.prototype.get=function(t){switch(t){case"userhandle":return this.username.split(" ").length>1?{text:this.username,fc:COLORS.userhandle,mf:30}:this.username.length>0?{text:"@"+this.username,fc:COLORS.userhandle,mf:30}:{text:"",fc:COLORS.userhandle,mf:30};case"photocredit":return{text:"@"+this.username,fc:COLORS.photocredit,mf:30};case"tweetbody":return{text:this.text,fc:COLORS.tweetbody,mf:40};case"hashtags":return"tags"in this&&0!=this.tags.length?{text:"#"+this.tags.slice(0,this._max_tags).join(" #").toUpperCase(),fc:COLORS.hashtags,mf:40}:{text:"",fc:COLORS.hashtags,mf:20};case"media":if("video"==this.type){var e=this.images.standard_resolution;return e.image=this.images.standard_resolution,e.video=this.videos.standard_resolution,e.dir=this.dir,e.n_frames=this.n_frames,e.type="video",e}var e=this.images.standard_resolution;return e.type="image",e;case"usericon":return this.usericon;default:return""}},Asset.prototype.isVideo=function(){return"video"===this.type},Asset.prototype.getUser=function(){return{platform:this.platform,username:this.username}};var Story=function(t){this.type="Zerobot",this.load(t),this.usedAssets=[]};Story.prototype.load=function(t){var e;if("phantom"==CONFIG.platform){var s=".data/"+t+"/story.json",o=loadFile(s);e=JSON.parse(o)}else{e=apiRequest(CONFIG.api_url+"story/"+t+"?q=keywords,hashtags")}for(var a in e)this[a]=e[a]},Story.prototype.get=function(t){switch(t){case"location":return{text:this.location.name.toUpperCase(),fc:COLORS.location,mf:30};case"title":return{text:this.name.toUpperCase(),fc:COLORS.title,mf:40};case"date":return{text:this.dateString,fc:COLORS.date,mf:20};case"userhandle":return{text:"@"+this.poster_full.username,fc:COLORS.userhandle,mf:30};case"media":return this.getAssets(1)[0].get("media");default:return""}},Story.prototype.getAsset=function(t){return new Asset(this.body[t])},Story.prototype.numAssetsLeft=function(){return this.body.length},Story.prototype.type=function(){return this.type},Story.prototype.getAssets=function(t){for(var e=[],s=0;s<Math.min(t,this.body.length);s++){var o=t>3?this.body.pop():this.body.shift();e.push(new Asset(o)),this.usedAssets.push(o)}return e},Story.prototype.getEndAssets=function(t){for(var e=this.getAssets(t),s=0;s<e.length;s++)e[s].type="image";if(e.length<t)for(var s=0;e.length<t;){s>=this.usedAssets.length&&(s=0);var o=this.usedAssets[s];o.type="image",e.push(new Asset(o)),s++}return e},Story.prototype.saveData=function(){for(var t={assets:[],hashtags:[],users:[]},e=0;e<this.hashtags.length;e++)t.hashtags.push("#"+this.hashtags[e]);for(var e=0;e<this.usedAssets.length;e++)t.assets.push({assetId:this.usedAssets[e].id,source:this.usedAssets[e].source,type:this.usedAssets[e].type,user:"@"+this.usedAssets[e].username,url:this.usedAssets[e].link}),t.users.push("@"+this.usedAssets[e].username);writeTextFile(".data/"+this.storyId+"/data.json",JSON.stringify(t))},Array.prototype.random=function(){return this[Math.floor(Math.random()*this.length)]};var COLORS={userhandle:[1,1,1],photocredit:[1,1,1],tweetbody:[1,1,1],hashtags:[1,1,1],location:[1,1,1],date:[1,1,1],title:[1,1,1]},VideoConstructor=function(t){this.duration=30,this.storyId="",this.blockIdx=1,this.frameRate=29.97,this.numBlocks=6,this.story=null,this.asset=null,this.blockId=null,this.animationItem=null,this.renderParams={container:document.getElementById("bodymovin"),renderer:CONFIG.renderer,loop:!1,autoplay:!0};for(var e in t)this[e]=t[e];this.log_data={blocks:[]},this.configure()};VideoConstructor.prototype.configure=function(){this.loadData(),"ACE"!=this.story.type?this.TM=new TemplateManager:this.TM=new TemplateManager({type:"template_ace",folder:"_templates_ace/"})},VideoConstructor.prototype.loadFonts=function(){this.fontManager=new FontManager,this.fontManager.loadFonts(["English","Numbers","ArialMT"])},VideoConstructor.prototype.loadColors=function(){this.colorManager=new ColorManager,this.colorManager.loadPallete("default")},VideoConstructor.prototype.loadData=function(){this.blockId&&(this.numBlocks=1,this.story=new Story(this.storyId)),this.assetId?(this.numBlocks=1,this.asset=new Asset(this.assetId)):this.story=new Story(this.storyId)},VideoConstructor.prototype.startRender=function(){this.loadNextBlock(!0)},VideoConstructor.prototype.goToNextFrame=function(){return!(null==this.animationItem&&this.blockIdx>this.numBlocks)&&(null==this.animationItem&&this.blockIdx<=this.numBlocks?(this.loadNextBlock(!1),this.currentFrame=1,this.animationItem.goToAndStop(1,!0)):this.animationItem.currentFrame<this.animationItem.totalFrames&&(this.currentFrame=this.currentFrame+1,this.animationItem.goToAndStop(this.animationItem.currentFrame+1,!0)),!0)},VideoConstructor.prototype.loadNextBlock=function(t){var e=this,s=this.getNextBlock();this.log_data.blocks.push(s.blockId),this.renderParams.animationData=s.animationData,this.renderParams.autoplay=t,bodymovin.destroy(),this.animationItem=bodymovin.loadAnimation(this.renderParams),console.log(this.animationItem),this.animationItem.addEventListener("DOMLoaded",function(){console.log(" - loaded")}),this.animationItem.addEventListener("enterFrame",function(){}),this.animationItem.addEventListener("complete",function(){e.animationItem=null,t&&e.blockIdx<=e.numBlocks&&e.loadNextBlock(t)})},VideoConstructor.prototype.getNextBlock=function(){if(this.blockId){var t=this.TM.getBlockById(this.blockId);return"title"==t.type?t.fillTemplate([this.story]):(res=t.fillTemplate(this.story.getEndAssets(t.animationData.placeholders.assets.length)),res.error&&console.log("error! not enough data to fill end block")),t}if(null==this.story){var t=this.TM.getContentBlock({maxAssets:1});return res=t.fillTemplate([this.asset]),this.blockIdx++,t}if(this.blockIdx==this.numBlocks&&"ACE"!=this.story.type){var t=this.TM.getEndBlock();res=t.fillTemplate(this.story.getEndAssets(t.animationData.placeholders.assets.length)),res.error&&console.log("error! not enough data to fill end block")}else if(1==this.blockIdx&&"ACE"!=this.story.type){var t=this.TM.getTitleBlock();t.fillTemplate([this.story])}else{var t=this.TM.getContentBlock({maxAssets:this.story.type=1});if(res=t.fillTemplate(this.story.getAssets(t.animationData.placeholders.assets.length)),res.error)return this.blockIdx=this.numBlocks,this.getNextBlock()}return this.blockIdx++,t};